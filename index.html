<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Geo Risk Map</title>
<style>
  body { font-family: Arial, sans-serif; }
  #map { width: 960px; height: 600px; margin: auto; }
  .tooltip {
    position: absolute;
    background-color: white;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 3px;
    pointer-events: none;
    font-size: 12px;
  }
</style>
</head>
<body>
<div id="map"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script>
const width = 960;
const height = 600;
const colors = {
  low: '#e0e0e0',
  offshore: 'yellow',
  fatf: 'orange',
  high: 'red',
  blocked: 'black'
};
const blocked = [
  'North Korea',
  'Iran',
  'Iraq',
  'Syria',
  'Lebanon',
  'Gaza Strip'
];
const highRisk = [
  'Algeria',
  'Afghanistan',
  'Jordan',
  'Palestine',
  'Libya',
  'United Arab Emirates',
  'Malaysia',
  'Egypt',
  'Turkey',
  'Morocco',
  'Sudan',
  'Somalia',
  'Saudi Arabia',
  'Pakistan',
  'Tunisia',
  'Yemen'
];
const fatfGrey = [
  'Turkey',
  'Jordan',
  'South Africa',
  'Philippines',
  'Panama'
];
const offshore = [
  'Bahamas',
  'British Virgin Islands',
  'Cayman Islands',
  'Panama',
  'Seychelles'
];
function getClassification(name) {
  const reasons = [];
  let cls = 'low';
  if (offshore.includes(name)) {
    cls = 'offshore';
    reasons.push('offshore jurisdiction');
  }
  if (fatfGrey.includes(name)) {
    if (cls === 'low' || cls === 'offshore') cls = 'fatf';
    reasons.push('appears on the FATF grey list');
  }
  if (highRisk.includes(name)) {
    if (cls === 'low' || cls === 'offshore' || cls === 'fatf') cls = 'high';
    reasons.push('listed as high risk');
  }
  if (blocked.includes(name)) {
    cls = 'blocked';
    reasons.push('blocked country');
  }
  return {cls, reason: reasons.join('; ')};
}
function getFlagEmoji(cc) {
  if (!cc) return '';
  return cc
    .split('')
    .map(c => String.fromCodePoint(127397 + c.charCodeAt(0)))
    .join('');
}
const projection = d3.geoMercator()
  .scale(150)
  .translate([width / 2, height / 1.5]);
const path = d3.geoPath().projection(projection);
const svg = d3.select('#map').append('svg')
  .attr('width', width)
  .attr('height', height);
const tooltip = d3.select('body').append('div')
  .attr('class', 'tooltip')
  .style('opacity', 0);
Promise.all([
  d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json'),
  d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/country-iso-3.json')
]).then(([world, iso]) => {
  const countries = topojson.feature(world, world.objects.countries).features;
  const isoMap = iso; // maps numeric id to {name, iso_a2}
  svg.selectAll('path')
    .data(countries)
    .enter().append('path')
    .attr('d', path)
    .attr('fill', d => {
      const info = isoMap[d.id];
      const name = info ? info.name : d.properties.name;
      const {cls} = getClassification(name);
      return colors[cls] || colors.low;
    })
    .attr('stroke', '#999')
    .on('mouseover', function(event, d) {
      const info = isoMap[d.id];
      const name = info ? info.name : d.properties.name;
      const cc = info ? info.iso_a2 : d.properties.iso_a2;
      const {cls, reason} = getClassification(name);
      tooltip.transition().duration(200).style('opacity', 0.9);
      tooltip.html(
        '<strong>' + name + '</strong> ' + getFlagEmoji(cc) + '<br/>' +
        cls + '<br/>' + reason
      )
      .style('left', (event.pageX + 5) + 'px')
      .style('top', (event.pageY - 28) + 'px');
    })
    .on('mouseout', function() {
      tooltip.transition().duration(500).style('opacity', 0);
    });
});
</script>
</body>
</html>
